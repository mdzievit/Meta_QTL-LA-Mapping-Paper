mutate(Check = 1) %>%
gather(Genotype,Pass,-Range,-Check) %>%
mutate(Row_Block = ifelse(Pass %% 4 != 0,
Pass %/% 4 + 1,
Pass %/% 4)) %>%
right_join(all_field %>%
select(-Genotype),
by = c("Pass","Range","Row_Block"))
row_block_tally <- field_layout_formatted %>%
na.omit() %>%
group_by(Row_Block,Genotype) %>%
summarise(Total = sum(Check, na.rm = TRUE)) %>%
ungroup() %>%
mutate(Final = 1) %>%
summarise(Final_Tally = sum(Final)) %>%
pull(Final_Tally)
}
return(field_layout)
}
check_design <- field_design(field_length = field_length,
field_width = field_width,
number_lines = number_lines,
number_checks = number_checks)
d <- data.frame(x1=rnorm(10),
x2=rnorm(10),
x3=rnorm(10))
d_cor <- as.matrix(cor(d))
d_cor_melt <- arrange(melt(d_cor), -abs(value))
d <- data.frame(x1=rnorm(10),
x2=rnorm(10),
x3=rnorm(10))
d <- data.frame(x1=rnorm(10),
x2=rnorm(10),
x3=rnorm(10))
View(d)
cor(d)
d_cor <- as.matrix(cor(d))
d_cor_melt <- arrange(melt(d_cor), -abs(value))
library(tidyverse)
library(reshape2)
d_cor_melt <- arrange(melt(d_cor), -abs(value))
View(d_cor_melt)
View(d_cor_melt)
library(tidyverse)
orange.df = Orange
orange.df$Tree = factor(as.numeric(orange.df$Tree))
orange.mod1 = lm(circumference ~ age, data = orange.df)
summary(orange.mod1)
orange.mod2 = lm(circumference ~ age + Tree, data = orange.df)
summary(orange.mod2)
anova(orange.mod1,orange.mod2)
View(orange.df)
orange.mod3 = lm(circumference ~ age + Tree + age:Tree, data = orange.df)
summary(orange.mod3)
anova(orange.mod2, orange.mod3)
lm(circumference ~ age:Tree, data = orange.df)
orange.mod3 = summary(lm(circumference ~ age:Tree, data = orange.df))
summary(lm(circumference ~ age:Tree, data = orange.df))
install.packages("gganimate")
install.packages("gganimate")
library(gganimate)
knitr::opts_chunk$set(message = FALSE, warning = FALSE, fig.show = "animate")
library(gganimate)
devtools::install_github("dgrtwo/gganimate")
install.packages("devtools")
install.packages("devtools")
library(rrBLUP)
#random population of 200 lines with 1000 markers
M <- matrix(rep(0,200*1000),200,1000)
View(M)
head(M)[1:5,1:5]
for (i in 1:200) {
M[i,] <- ifelse(runif(1000)<0.5,-1,1)
}
head(M)[1:5,1:5]
rownames(M) <- 1:200
A <- A.mat(M)
#random phenotypes
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
#random phenotypes
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- data.frame(y=y,gid=1:200)
head(data)[1:5,1:5]
head(data)[1:5,1:2
]
head(A)[1:5,1:5]
#predict breeding values
ans <- kin.blup(data=data,geno="gid",pheno="y",K=A)
accuracy <- cor(g,ans$g)
ans$g
ans$g[1:10]
ans$g[1:10]
#random phenotypes
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- rbind(data.frame(y = y, gid = 1:200))
c(rep(1,200),rep(2,200))
data$Env <- c(rep(1,200),rep(2,200))
#random phenotypes
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- data.frame(y=y,gid=1:200)
#random phenotypes
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- rbind(data,data.frame(y = y, gid = 1:200))
data$Env <- c(rep(1,200),rep(2,200))
#predict breeding values
ans <- kin.blup(data=data,geno="gid",pheno="y",K=A, fixed = c("Env"))
accuracy <- cor(g,ans$g)
ans$g
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- data.frame(y=y,gid=1:200)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- rbind(data,data.frame(y = y, gid = 1:200))
data$Env <- c(rep(1,200),rep(2,200))
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- data.frame(y=y,gid=1:200)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.6 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- rbind(data,data.frame(y = y, gid = 1:200))
data$Env <- c(rep(1,200),rep(2,200))
#predict breeding values
ans <- kin.blup(data=data,geno="gid",pheno="y",K=A, fixed = c("Env"))
accuracy <- cor(g,ans$g)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- data.frame(y=y,gid=1:200)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.6 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- rbind(data,data.frame(y = y, gid = 1:200))
data$Env <- c(rep(1,200),rep(2,200))
#predict breeding values
ans <- kin.blup(data=data,geno="gid",pheno="y",K=A, fixed = c("Env"))
accuracy <- cor(g,ans$g)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- data.frame(y=y,gid=1:200)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.6 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- rbind(data,data.frame(y = y, gid = 1:200))
data$Env <- c(rep(1,200),rep(2,200))
#predict breeding values
ans <- kin.blup(data=data,geno="gid",pheno="y",K=A, fixed = c("Env"))
accuracy <- cor(g,ans$g)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- data.frame(y=y,gid=1:200)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.6 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- rbind(data,data.frame(y = y, gid = 1:200))
data$Env <- c(rep(1,200),rep(2,200))
#predict breeding values
ans <- kin.blup(data=data,geno="gid",pheno="y",K=A, fixed = c("Env"))
accuracy <- cor(g,ans$g)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- data.frame(y=y,gid=1:200)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.6 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- rbind(data,data.frame(y = y, gid = 1:200))
data$Env <- c(rep(1,200),rep(2,200))
#predict breeding values
ans <- kin.blup(data=data,geno="gid",pheno="y",K=A, fixed = c("Env"))
accuracy <- cor(g,ans$g)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- data.frame(y=y,gid=1:200)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.6 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- rbind(data,data.frame(y = y, gid = 1:200))
data$Env <- c(rep(1,200),rep(2,200))
#predict breeding values
ans <- kin.blup(data=data,geno="gid",pheno="y",K=A, fixed = c("Env"))
accuracy <- cor(g,ans$g)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.5 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- data.frame(y=y,gid=1:200)
u <- rnorm(1000)
g <- as.vector(crossprod(t(M),u))
h2 <- 0.6 #heritability
y <- g + rnorm(200,mean=0,sd=sqrt((1-h2)/h2*var(g)))
data <- rbind(data,data.frame(y = y, gid = 1:200))
data$Env <- c(rep(1,200),rep(2,200))
#predict breeding values
ans <- kin.blup(data=data,geno="gid",pheno="y",K=A, fixed = c("Env"))
accuracy <- cor(g,ans$g)
N <- 10^6
X <- rchisq(N, 3)
w <- dexp(X, 1) / dchisq(X, 3)
Y <- log(1+X)*w #h(x)*w(x)
N <- 10^3
X <- rchisq(N, 3)
w <- dexp(X, 1) / dchisq(X, 3)
Y <- log(1+X)*w #h(x)*w(x)
mean(Y)
sd(Y)/sqrt(N)
c(mean(Y)-2*sd(Y)/sqrt(N),
mean(Y)+2*sd(Y)/sqrt(N))
Xe <- rexp(N, 1/2)
we <- dexp(Xe, 1) / dexp(Xe, 1/2)
Ye <- log(1+Xe)*we
mean(Ye)
sd(Ye)/sqrt(N)
c(mean(Ye)-2*sd(Ye)/sqrt(N),
mean(Ye)+2*sd(Ye)/sqrt(N))
library(tidyverse)
tidy <- as_tibble(cbind(X, Xe, Y, Ye))
View(tidy)
Xtib <- as_tibble(cbind(X, Xe)) %>%
gather(Xs, Xvalue)
View(Xtib)
Ytib <- as_tibble(cbind(Y, Ye)) %>%
gather(Ys, Yvalue)
View(Xtib)
View(Ytib)
as_tibble(cbind(Y, Ye))
View(Ytib)
Alltib <- cbind(Xtib, Ytib)
View(Alltib)
ggplot(Alltib, aes(x=Xvalue, y=Yvalue, col = Xs)) +
geom_point()
View(Alltib)
setwd("C:/Users/mdzievit.IASTATE/Box Sync/Manuscripts")
library(sensitivitymv)
library(tidyverse)
library(survcomp)
library(grid)
library(gridExtra)
##Analysis done with RefGen V3
print(sessionInfo())
######Determine Total Genomic Bins in genome #######
##Sets the genomic bin size for the meta-analysis
####And sets the value to convert LRT to chi sq and the number of df used to
####convert to p-values
bins <- 10000000
two_loge10 <- (2*log(10))
df <- 1
##Reads in the chr lengths and calculates total bins per chr
chrLengths <- read_tsv("RefGenV3_Chr_Lengths.txt") %>%
mutate(Bins = (Length %/% bins) + 1)
##Calculates the total number of genomic bins for the genome and reports it back
totalBinNum <- chrLengths %>%
summarise(Total = sum(Bins)) %>%
pull(Total)
##This expands out the total possible bins so I can get a row_order for
##all the bins. This allows me to plot them in physical position
##on the x-axis. I also added an extra bin to the end of each chromosome
##This is purely for plotting purposes so I can have the dotted gray line separate chromosomes
##and not overlap with a bin that might be at the end of a chromosome.
total_bins <- data.frame(Chr = numeric(0),
Bin = numeric(0))
bin_num <- chrLengths %>%
pull(Bins)
for (i in 1:10) {
for (j in 1:(bin_num[i] + 1)) {
total_bins <- total_bins %>%
add_row(Chr = i,
Bin = j)
}
}
############Run the meta-analysis ########
##Reads the QTL information
data <- read_delim("snps_pvalues_final_version.txt",
delim = "\t")
####Assigns the QTL to a genomic bin and ranks the p_value by QTL study and
####canopy level the QTL was detected in so we can remove redundant QTLs
data_bin <- data %>%
arrange(Chr,Start,End) %>%
mutate(Midpoint = (Start + End)/2,
Bin = (Midpoint %/% bins) + 1,
p_value = case_when(
!is.na(LOD) & is.na(p_value) ~ dchisq((LOD * two_loge10),df),
!is.na(LRT) & is.na(p_value) ~ dchisq(log10(LRT) * two_loge10 ,df),
TRUE ~ p_value)) %>%
arrange(Chr,Midpoint) %>%
ungroup() %>%
group_by(SourceID,Chr,Bin) %>%
mutate(pvalue_rank = rank(p_value, ties.method = "first")) %>%
ungroup() %>%
arrange(SourceID,Chr,Bin) %>%
select(-LRT,-LOD)
!is.na(LOD) & is.na(p_value) ~ dchisq((LOD * two_loge10),df),
!is.na(LRT) & is.na(p_value) ~ dchisq(log10(LRT) * two_loge10 ,df),
TRUE ~ p_value),
p_value2 = ifelse(!is.na(LRT) & is.na(p_value),dchisq(LRT,df),p_value) %>%
arrange(Chr,Midpoint) %>%
ungroup() %>%
group_by(SourceID,Chr,Bin) %>%
mutate(pvalue_rank = rank(p_value, ties.method = "first")) %>%
ungroup() %>%
arrange(SourceID,Chr,Bin) %>%
select(-LRT,-LOD)
####Assigns the QTL to a genomic bin and ranks the p_value by QTL study and
####canopy level the QTL was detected in so we can remove redundant QTLs
data_bin <- data %>%
####Assigns the QTL to a genomic bin and ranks the p_value by QTL study and
####canopy level the QTL was detected in so we can remove redundant QTLs
data_bin <- data %>%
arrange(Chr,Start,End) %>%
mutate(Midpoint = (Start + End)/2,
Bin = (Midpoint %/% bins) + 1,
p_value = case_when(
!is.na(LOD) & is.na(p_value) ~ dchisq((LOD * two_loge10),df),
!is.na(LRT) & is.na(p_value) ~ dchisq(log10(LRT) * two_loge10 ,df),
TRUE ~ p_value),
p_value2 = ifelse(!is.na(LRT) & is.na(p_value),dchisq(LRT,df),p_value)) %>%
arrange(Chr,Midpoint) %>%
ungroup() %>%
group_by(SourceID,Chr,Bin) %>%
mutate(pvalue_rank = rank(p_value, ties.method = "first")) %>%
ungroup() %>%
arrange(SourceID,Chr,Bin) %>%
select(-LRT,-LOD)
library(sensitivitymv)
library(tidyverse)
library(survcomp)
library(grid)
library(gridExtra)
############Run the meta-analysis ########
##Reads the QTL information
data <- read_delim("snps_pvalues_final_version.txt",
delim = "\t")
setwd("C:/Users/mdzievit.IASTATE/Box Sync/Manuscripts/MLA-QTL_Mapping/Meta_QTL-LA-Mapping-Paper/4.Meta-Analysis_code_and_files")
##Analysis done with RefGen V3
print(sessionInfo())
######Determine Total Genomic Bins in genome #######
##Sets the genomic bin size for the meta-analysis
####And sets the value to convert LRT to chi sq and the number of df used to
####convert to p-values
bins <- 10000000
two_loge10 <- (2*log(10))
df <- 1
##Reads in the chr lengths and calculates total bins per chr
chrLengths <- read_tsv("RefGenV3_Chr_Lengths.txt") %>%
mutate(Bins = (Length %/% bins) + 1)
##Calculates the total number of genomic bins for the genome and reports it back
totalBinNum <- chrLengths %>%
summarise(Total = sum(Bins)) %>%
pull(Total)
##This expands out the total possible bins so I can get a row_order for
##all the bins. This allows me to plot them in physical position
##on the x-axis. I also added an extra bin to the end of each chromosome
##This is purely for plotting purposes so I can have the dotted gray line separate chromosomes
##and not overlap with a bin that might be at the end of a chromosome.
total_bins <- data.frame(Chr = numeric(0),
Bin = numeric(0))
bin_num <- chrLengths %>%
pull(Bins)
for (i in 1:10) {
for (j in 1:(bin_num[i] + 1)) {
total_bins <- total_bins %>%
add_row(Chr = i,
Bin = j)
}
}
############Run the meta-analysis ########
##Reads the QTL information
data <- read_delim("snps_pvalues_final_version.txt",
delim = "\t")
####Assigns the QTL to a genomic bin and ranks the p_value by QTL study and
####canopy level the QTL was detected in so we can remove redundant QTLs
data_bin <- data %>%
arrange(Chr,Start,End) %>%
mutate(Midpoint = (Start + End)/2,
Bin = (Midpoint %/% bins) + 1,
p_value = case_when(
!is.na(LOD) & is.na(p_value) ~ dchisq((LOD * two_loge10),df),
!is.na(LRT) & is.na(p_value) ~ dchisq(log10(LRT) * two_loge10 ,df),
TRUE ~ p_value),
p_value2 = ifelse(!is.na(LRT) & is.na(p_value),dchisq(LRT,df),p_value)) %>%
arrange(Chr,Midpoint) %>%
ungroup() %>%
group_by(SourceID,Chr,Bin) %>%
mutate(pvalue_rank = rank(p_value, ties.method = "first")) %>%
ungroup() %>%
arrange(SourceID,Chr,Bin) %>%
select(-LRT,-LOD)
View(data_bin)
####Assigns the QTL to a genomic bin and ranks the p_value by QTL study and
####canopy level the QTL was detected in so we can remove redundant QTLs
data_bin <- data %>%
arrange(Chr,Start,End) %>%
mutate(Midpoint = (Start + End)/2,
Bin = (Midpoint %/% bins) + 1,
p_value = case_when(
!is.na(LOD) & is.na(p_value) ~ dchisq((LOD * two_loge10),df),
!is.na(LRT) & is.na(p_value) ~ dchisq(log10(LRT) * two_loge10 ,df),
TRUE ~ p_value),
p_value2 = ifelse(!is.na(LRT) & is.na(p_value),dchisq(LRT,df),p_value)) %>%
arrange(Chr,Midpoint) %>%
ungroup() %>%
group_by(SourceID,Chr,Bin) %>%
mutate(pvalue_rank = rank(p_value, ties.method = "first")) %>%
ungroup() %>%
arrange(SourceID,Chr,Bin) %>%
select(-LRT,-LOD) %>%
mutate(equal = p_value == p_value2)
View(data_bin)
View(data)
View(data_bin)
log10(3)
* two_loge10
log10(3) * two_loge10
dchisq(3,1)
####Assigns the QTL to a genomic bin and ranks the p_value by QTL study and
####canopy level the QTL was detected in so we can remove redundant QTLs
data_bin <- data %>%
arrange(Chr,Start,End) %>%
mutate(Midpoint = (Start + End)/2,
Bin = (Midpoint %/% bins) + 1,
p_value = case_when(
!is.na(LOD) & is.na(p_value) ~ dchisq((LOD * two_loge10),df),
!is.na(LRT) & is.na(p_value) ~ dchisq(log10(LRT) * two_loge10 ,df),
TRUE ~ p_value),
p_value2 = ifelse(!is.na(LRT) & is.na(p_value),dchisq(LRT,df),"No")) %>%
arrange(Chr,Midpoint) %>%
ungroup() %>%
group_by(SourceID,Chr,Bin) %>%
mutate(pvalue_rank = rank(p_value, ties.method = "first")) %>%
ungroup() %>%
arrange(SourceID,Chr,Bin) %>%
select(-LRT,-LOD) %>%
mutate(equal = p_value == p_value2)
View(data_bin)
####Assigns the QTL to a genomic bin and ranks the p_value by QTL study and
####canopy level the QTL was detected in so we can remove redundant QTLs
data_bin <- data %>%
arrange(Chr,Start,End) %>%
mutate(Midpoint = (Start + End)/2,
Bin = (Midpoint %/% bins) + 1,
p_value2 = case_when(
!is.na(LOD) & is.na(p_value) ~ dchisq((LOD * two_loge10),df),
!is.na(LRT) & is.na(p_value) ~ dchisq(log10(LRT) * two_loge10 ,df),
TRUE ~ p_value),
p_value3 = ifelse(!is.na(LRT) & is.na(p_value),dchisq(LRT,df),"No")) %>%
arrange(Chr,Midpoint) %>%
ungroup() %>%
group_by(SourceID,Chr,Bin) %>%
mutate(pvalue_rank = rank(p_value, ties.method = "first")) %>%
ungroup() %>%
arrange(SourceID,Chr,Bin) %>%
select(-LRT,-LOD) %>%
mutate(equal = p_value == p_value2)
View(data_bin)
####Assigns the QTL to a genomic bin and ranks the p_value by QTL study and
####canopy level the QTL was detected in so we can remove redundant QTLs
data_bin <- data %>%
arrange(Chr,Start,End) %>%
mutate(Midpoint = (Start + End)/2,
Bin = (Midpoint %/% bins) + 1,
p_value2 = case_when(
!is.na(LOD) & is.na(p_value) ~ dchisq((LOD * two_loge10),df),
!is.na(LRT) & is.na(p_value) ~ dchisq(log10(LRT) * two_loge10 ,df),
TRUE ~ p_value),
p_value3 = ifelse(!is.na(LRT) & is.na(p_value),dchisq(LRT,df),p_value2)) %>%
arrange(Chr,Midpoint) %>%
ungroup() %>%
group_by(SourceID,Chr,Bin) %>%
mutate(pvalue_rank = rank(p_value, ties.method = "first")) %>%
ungroup() %>%
arrange(SourceID,Chr,Bin) %>%
select(-LRT,-LOD) %>%
mutate(equal = p_value == p_value2)
View(data_bin)
View(data)
